---
title: "Plot_2_veel_iteraties"
output: html_document
date: '2023-05-05'
---

- Assumes that the functions from Simulatie_2_veel_iteraties.rmd are in the global environment.
- Assumes that the objects LC_models, LCT_models and treeMILC_models are in the global environment.


```{r}
group.colors <- c(LC = "#F8766D", LCT = "#00BA38", "tree-MILC" ="#619CFF")
group.colors2 <- c(LC = "#F8766D", LCT ="#00BA38")
```

## Get results

```{r}
get_results = function(models){
  
  results_df = data.frame(iteration=NA,indicator=NA,cov_ok=NA,cov_problem=NA,N=NA,ME=NA,id=NA,
                          full_id=NA,prop1=NA,prop2=NA,prop3=NA,entropy=NA,ME1.1=NA,ME1.2=NA,ME1.3=NA,ME2.1=NA,ME2.2=NA,ME2.3=NA,diag=NA,var=NA)
  
  for(i in 1:length(models)){
    print(i)
    model = models[[i]]
    
    model1 = model[[1]]
    
    model_name = paste(as.numeric(model1$ind),model1$cov_ok,model1$cov_problem,as.numeric(model1$N),as.numeric(model1$ME),sep="-")
    entropy = ifelse(length(model[[2]])!=5,get_entropy(model)[1],NA)
    # entropy = NA

    if(model1$ME==4){
      ME1.1 = get_estimated_ME(model,1)[1]
      ME2.1 = get_estimated_ME(model,1)[2]
      ME1.2 = get_estimated_ME(model,2)[1]
      ME2.2 = get_estimated_ME(model,2)[2]
      ME1.3 = get_estimated_ME(model,3)[1]
      ME2.3 = get_estimated_ME(model,3)[2]
    }
    else {
      ME1.1 = get_estimated_ME(model,1)
      ME2.1 = NA
      ME1.2 = get_estimated_ME(model,2)
      ME2.2 = NA
      ME1.3 = get_estimated_ME(model,3)
      ME2.3 = NA
    }
    diag = get_diff_ME_diagonal_noabs(model)

    
    row = c(as.numeric(model1$iteration),as.numeric(model1$ind),
            model1$cov_ok,model1$cov_problem,as.numeric(model1$N),
            as.numeric(model1$ME),model_name,full_id=model1$id,
            get_proportions(model)[1],get_proportions(model)[2],
            get_proportions(model)[3],entropy,ME1.1,ME1.2,ME1.3,ME2.1,ME2.2,ME2.3,diag,tM_var(model)[[1]])
    results_df[i,] = row
  }
  
  return(results_df)
}


# LC_results3 = get_results(LC_models3)
# LCT_results3 = get_results(LCT_models3)
treeMILC_results2 = get_results(treeMILC_models)

# LC_results_10000 = get_results(LC_models_10000)
# LCT_results_10000 = get_results(LCT_models_10000)
# treeMILC_results_10000 = get_results(treeMILC_models_10000)

```


## Get summary

```{r}
get_summary = function(type,model_results){
  
  convert = c("prop1","prop2","prop3","entropy","ME1.1","ME1.2","ME1.3","ME2.1","ME2.2","ME2.3","diag")
  model_results[ , convert] <- apply(model_results[ , convert], 2,function(x) as.numeric(as.character(x)))
  
  summary1 = as.data.frame(model_results %>%  group_by(indicator,cov_ok,cov_problem,N,ME,id) %>%   
  summarise_at(c("prop1","prop2","prop3","entropy","ME1.1","ME1.2","ME1.3","ME2.1","ME2.2","ME2.3","diag"), mean))
  
  summary1$rmse_prop1 = summary1$rmse_prop2 = summary1$rmse_prop3 = NA

  split_df=split(model_results, model_results$id)
  
  #Compute RMSE
  for(i in 1:length(split_df)){
    ME = split_df[[i]]$ME[1]
    nsim = nrow(split_df[[i]])
    ME_matrix = get(paste0("ME_matrix",ME))
    summary1[summary1$id == split_df[[i]]$id[1],]$rmse_prop1 = sqrt(sum((split_df[[i]]$prop1-true_proportions[1])^2)/nsim)
    summary1[summary1$id == split_df[[i]]$id[1],]$rmse_prop2 = sqrt(sum((split_df[[i]]$prop2-true_proportions[2])^2)/nsim)
    summary1[summary1$id == split_df[[i]]$id[1],]$rmse_prop3 = sqrt(sum((split_df[[i]]$prop3-true_proportions[3])^2)/nsim)
  }
  
  summary2 = as.data.frame(model_results %>%  group_by(indicator,cov_ok,cov_problem,N,ME,id) %>% 
  summarise_at(c("prop1","prop2","prop3","entropy","ME1.1","ME1.2","ME1.3","ME2.1","ME2.2","ME2.3"), sd))[,-c(1:6)]
  names(summary2) = c("sd_prop1","sd_prop2","sd_prop3","sd_entropy","sd_ME1.1","sd_ME1.2","sd_ME1.3","sd_ME2.1","sd_ME2.2","sd_ME2.3")

  summary = cbind(summary1,summary2)
  summary$type = type
  
  return(summary)
}


# LC_summary = get_summary("LC",LC_results[LC_results$cov_problem!="SBIgroep",])
# LCT_summary = get_summary("LCT",LCT_results[LCT_results$cov_problem!="SBIgroep",])
# treeMILC_summary = get_summary("tree-MILC",treeMILC_results[treeMILC_results$cov_problem!="SBIgroep",])

LC_summary3 = get_summary("LC",LC_results3)
LCT_summary3 = get_summary("LCT",LCT_results3)
treeMILC_summary3 = get_summary("tree-MILC",treeMILC_results3)

```


```{r}
get_estimated_ME = function(model, contract){
  
  ME = model[[1]]$ME
  
  if(ME==4){
    ME_estimated = get_ME(model)
    ind = length(ME_estimated)
    
    first = ME_estimated[seq(1,ind,2)]
    second = ME_estimated[seq(2,ind,2)]
    
    if(length(first)>1){
      x = get_mean_matrix(first)
      first = matrix(unlist(x), ncol = 3, byrow = TRUE)
      first = first[contract,contract]
    } else {
      first = first[[1]][contract,contract]
    }
    
    if(length(second)>1){
      y = get_mean_matrix(second)
      second = matrix(unlist(y), ncol = 3, byrow = TRUE)
      second = second[contract,contract]
    } else {
      second = second[[1]][contract,contract]
    }

    return(c(first, second))
    
  } else {
    
    ME_estimated = get_mean_matrix(get_ME(model))
    ME_estimated = matrix(unlist(ME_estimated), ncol = 3, byrow = TRUE)
    return(ME_estimated[contract,contract])
  }
}

``` 

#lijst van alle modellen met precies dezelfde iteratie dinges


Model_list: A list of models with the same parameters but different iteration versions

```{r}
get_indicator_rmse_help = function(model_list,indicator,contract){
  
  #Store estimated measurement error probabilities in a vector
  ME_vec = vector()
  
  for(i in model_list){
    ME_vec = c(ME_vec,get_ME(i)[[indicator]][contract,contract])
  }
  
  #Get true value  
  ME_matrix = get(paste0("ME_matrix",as.numeric(model_list[[1]][[1]]$ME)))
  
  if(model_list[[1]][[1]]$ME==4){ #For realistic ME scenario
    print("yes2")
    if(indicator==1|indicator==3){
      true_value = ME_matrix[[1]][contract,contract]
    } else {
      true_value = ME_matrix[[2]][contract,contract]
    }
  } else {
    true_value = ME_matrix[contract,contract]
  }
    
  #Compute RMSE
  rmse = sqrt(sum((ME_vec-true_value)^2)/length(model_list))

  return(rmse)
}

```


```{r}
get_indicator_rmse = function(models,model_results){
  
  id = unique(model_results$id)
  df = data.frame(indicator=NA,cov_ok=NA,cov_problem=NA,N=NA,ME=NA,id=NA,rmse=NA,ind=NA,Contract=NA)

  for(i in id){
    model_sub = models[as.numeric(rownames(model_results[model_results$id==i,]))]
    num_ind = model_sub[[1]][[1]]$ind
    b = model_sub[[1]][[1]]$cov_ok
    bb = model_sub[[1]][[1]]$cov_problem
    c = model_sub[[1]][[1]]$N
    d = model_sub[[1]][[1]]$ME
    
    for(j in 1:num_ind){
      for(k in 1:3){
      row = c(num_ind, b, bb, c, d, i,get_indicator_rmse_help(model_sub, j,k),j,k)
      df = rbind(df,row)
      }
    }
  }
  return(df[-1,])
} 

```


# Get results and combine data

```{r}

LC_results = get_results(LC_models)
LCT_results = get_results(LCT_models)
treeMILC_results = get_results(treeMILC_models_poging2[1:1200])

LC_summary=get_summary("LC",LC_results)
LCT_summary=get_summary("LCT",LCT_results)
treeMILC_summary=get_summary("treeMILC",treeMILC_results)

all_joined_org = all_joined
all_joined = all_joined2
all_joined = rbind(LC_summary3,LCT_summary3,treeMILC_summary3)
all_joined_1000$diag3 = all_joined_1000$diag*3

all_joined_10000 = rbind(LC_summary_10000,LCT_summary_10000,treeMILC_summary_10000)
all_joined_10000$diag3 = all_joined_10000$diag*3
all_joined_10000$indicator = as.numeric(all_joined_10000$indicator)
all_joined_10000$N = as.numeric(all_joined_10000$N)
all_joined_10000$ME = as.numeric(all_joined_10000$ME)

all_joined = rbind(all_joined_1000,all_joined_10000)
```


# Prepare and plot data for conditions with 10%, 20% and 30% measurement error:
- Population proportion estimates (also includes a realistic amount of measurement error)
- RMSE of population proportion estimates (also includes a realistic amount of measurement error)
- Measurement error probability estimates

```{r}
#Prepare data for plotting
perm = all_joined[,c(names(all_joined)[1:5],"prop1","rmse_prop1","sd_prop1","type","ME1.1","ME2.1","sd_ME1.1","sd_ME2.1")]
names(perm) = c(names(all_joined)[1:5],"prop","rmse","sd","type","ME1","ME2","sd_ME1","sd_ME2")
perm$Contract = "Permanent"
perm$hline = true_proportions[1]

other = all_joined[,c(names(all_joined)[1:5],"prop2","rmse_prop2","sd_prop2","type","ME1.2","ME2.2","sd_ME1.2","sd_ME2.2")]
names(other) = c(names(all_joined)[1:5],"prop","rmse","sd","type","ME1","ME2","sd_ME1","sd_ME2")
other$Contract = "Other"
other$hline = true_proportions[2]

flex = all_joined[,c(names(all_joined)[1:5],"prop3","rmse_prop3","sd_prop3","type","ME1.3","ME2.3","sd_ME1.3","sd_ME2.3")]
names(flex) = c(names(all_joined)[1:5],"prop","rmse","sd","type","ME1","ME2","sd_ME1","sd_ME2")
flex$Contract = "Flexible"
flex$hline = true_proportions[3]

df = rbind(perm, flex, other)
df$Contract = as.factor(df$Contract)
df$Contract = factor(df$Contract, levels = c("Permanent", "Flexible", "Other"))
# df[df$type=="treeMILC",]$type = "tree-MILC"

df$mline = NA
df[df$Contract=="Permanent"&df$ME==1,]$mline = ME_matrix1[1,1] 
df[df$Contract=="Other"&df$ME==1,]$mline = ME_matrix1[2,2] 
df[df$Contract=="Flexible"&df$ME==1,]$mline = ME_matrix1[3,3] 
df[df$Contract=="Permanent"&df$ME==2,]$mline = ME_matrix2[1,1] 
df[df$Contract=="Other"&df$ME==2,]$mline = ME_matrix2[2,2] 
df[df$Contract=="Flexible"&df$ME==2,]$mline = ME_matrix2[3,3] 
df[df$Contract=="Permanent"&df$ME==3,]$mline = ME_matrix3[1,1] 
df[df$Contract=="Other"&df$ME==3,]$mline = ME_matrix3[2,2] 
df[df$Contract=="Flexible"&df$ME==3,]$mline = ME_matrix3[3,3] 

df[df$ME==1,]$ME = "10%"
df[df$ME==2,]$ME = "20%"
df[df$ME==3,]$ME = "30%"
df[df$ME==4,]$ME = "approx. 10% (realistic)"
df$ME = as.factor(df$ME)
df$ME <- relevel(df$ME, "approx. 10% (realistic)")
```

```{r}
#Plot population proportion estimates (includes all conditions with measurement error)
j=1000
plot_df = df[df$N==j&df$ME!="approx. 10% (realistic)",]
g = plot_df %>% ggplot( aes(x=indicator, y=prop, fill=type)) + geom_bar(stat='identity', position='dodge')  + scale_fill_manual(name="Model",values=group.colors)
g = g + labs(y= "Population proportion estimates", x = "Number of indicators") 
g = g + facet_grid(rows = vars(Contract),cols=vars(ME),labeller=label_both) + geom_hline(aes(yintercept=hline), color = "black",size=0.3)
p5 = g + geom_errorbar(aes(ymin=prop-sd, ymax=prop+sd), width=.25, size=0.3, position=position_dodge(.9))
filename = paste0("F:/Documents/Thesis/Schrijfbestanden/figures/EstimatedProp_N_",j,".pdf")
# ggsave(plot = g, width = 10, height = 5, dpi = 300, filename = filename)
```


```{r}
#Plot RMSE of population proportion estimates (includes all conditions with measurement error)
N=c(1000,10000)
for(j in N){
  j=10000
  plot_df = df[df$N==j&df$ME!="approx. 10% (realistic)",]
  g = plot_df %>% ggplot( aes(x=indicator, y=rmse, fill=type)) + geom_bar(stat='identity', position='dodge') + 
  scale_fill_manual(name="Model",values=group.colors)
  g = g + labs(y= "RMSE", x = "Number of indicators") 
  p6 = g + facet_grid(rows = vars(Contract),cols=vars(ME),labeller=label_both) 
  filename = paste0("F:/Documents/Thesis/Schrijfbestanden/figures/EstimatedProp_N_",j,"_RMSE.pdf")
  # ggsave(plot = g, width = 10, height = 5, dpi = 300, filename = filename)
}

N10000=grid.arrange(p1,p2,p3,p4,ncol=2)
N10000=grid.arrange(p5,p6,p7,p8,ncol=2)

```

```{r}
#Plot measurement probability estimates (only 10%, 20% and 30% measurement error)
N = c(1000,10000)
for(j in N){
  j=10000
  plot_df1 = df[df$N==j&df$ME!="approx. 10% (realistic)",]
  g = plot_df1 %>% ggplot( aes(x=indicator, y=ME1, fill=type)) + geom_bar(stat='identity', position='dodge')  + 
  scale_fill_manual(name="Model",values=group.colors) 
  g = g  + labs(y= "Measurement error probability estimates", x = "Number of indicators")  + geom_errorbar(aes(ymin=ME1-sd_ME1, ymax=ME1+sd_ME1), width=.25, size=0.3, position=position_dodge(.9))
  p7 = g + facet_grid(rows = vars(Contract),cols=vars(ME),labeller=label_both) + geom_hline(aes(yintercept=mline), color = "black",size=0.3 )
  filename = paste0("F:/Documents/Thesis/Schrijfbestanden/figures/ME_N_",j,".pdf")
  ggsave(plot = g, width = 7, height = 5, dpi = 300, filename = filename)
}
```


# Prepare and plot data for conditions with 10%, 20% and 30% measurement error:
- RMSE of measurement error probability estimates

```{r}
#Prepare data for plotting
# LC_ME_rmse=get_indicator_rmse(LC_models,LC_results)
LC_ME_rmse$rmse = as.numeric(LC_ME_rmse$rmse)
LC_ME_rmse$type = "LC"

# LCT_ME_rmse=get_indicator_rmse(LCT_models,LCT_results)
LCT_ME_rmse$type = "LCT"
LCT_ME_rmse$rmse = as.numeric(LCT_ME_rmse$rmse)

# treeMILC_ME_rmse=get_indicator_rmse(treeMILC_models,treeMILC_results)
treeMILC_ME_rmse$rmse = as.numeric(treeMILC_ME_rmse$rmse)
treeMILC_ME_rmse$type = "tree-MILC"

df_ME = rbind(LC_ME_rmse,LCT_ME_rmse,treeMILC_ME_rmse)
df_ME$ME = as.numeric(df_ME$ME)
df_ME$ind = as.numeric(df_ME$ind)

#Recode indicator names where ME = realistic
df_ME[df_ME$ME==4&(df_ME$ind==1|df_ME$ind==3),]$ind = 1
df_ME[df_ME$ME==4&(df_ME$ind==2|df_ME$ind==4),]$ind = 2

#Take mean RMSE over all indicators
df_ME_not4 = df_ME[df_ME$ME!=4,] 
df_ME_not4 = as.data.frame(df_ME_not4 %>%  group_by(indicator,covariate,N,ME,id,Contract,type) %>% summarise_at(c("rmse"), mean))
df_ME_not4$ind = NA
df_ME_4 = df_ME[df_ME$ME==4,] 
df_ME_4 = as.data.frame(df_ME_4 %>%  group_by(indicator,covariate,N,ME,id,ind,Contract,type) %>% summarise_at(c("rmse"), mean))
df_ME = rbind(df_ME_4,df_ME_not4)

df_ME$Contract = as.factor(df_ME$Contract)
df_ME[df_ME$ME==1,]$ME = "10%"
df_ME[df_ME$ME==2,]$ME = "20%"
df_ME[df_ME$ME==3,]$ME = "30%"
df_ME[df_ME$ME==4,]$ME = "approx. 10% (realistic)"
df_ME$ME = as.factor(df_ME$ME)
df_ME$ME <- relevel(df_ME$ME, "approx. 10% (realistic)")
levels(df_ME$Contract) = c("Permanent","Other", "Flexible")
df_ME$Contract <- factor(df_ME$Contract, levels = c("Permanent", "Flexible", "Other"))
```

```{r}
#Plot RMSE of measurement error probability estimates (only 10%, 20% and 30% measurement error)
for(j in N){
  j=10000
  plot_df1 = df_ME[df_ME$N==j&df_ME$ME!="approx. 10% (realistic)",]
  g = plot_df1 %>% ggplot( aes(x=indicator, y=rmse, fill=type)) + geom_bar(stat='identity', position='dodge')  + scale_fill_manual(name="Model",values=group.colors) 
  g = g  + labs(y= "RMSE of measurement error probability estimates", x = "Number of indicators")
  p8 = g + facet_grid(rows = vars(Contract),cols=vars(ME),labeller=label_both) 
  filename = paste0("F:/Documents/Thesis/Schrijfbestanden/figures/ME_N_",j,"_RMSE.pdf")
  # ggsave(plot = g, width = 7, height = 5, dpi = 300, filename = filename)
}
```


# Prepare and plot data for conditions with a realistic amount of measurement error:
- Measurement error probability estimates
- RMSE of measurement error probability estimates

```{r}
#Prepare data for plotting
plot_ME4 = df[df$ME=="approx. 10% (realistic)",]
plot_ind1 = cbind(plot_ME4[,1:5],plot_ME4[,c("type","Contract","ME1","sd_ME1")])
plot_ind1$Indicator = "Type 1"
plot_ind2 = cbind(plot_ME4[,1:5],plot_ME4[,c("type","Contract","ME2","sd_ME2")])
plot_ind2$Indicator = "Type 2"

setnames(plot_ind1,old=c("ME1","sd_ME1"),new=c("MEP","sd_MEP"))
setnames(plot_ind2,old=c("ME2","sd_ME2"),new=c("MEP","sd_MEP"))

plot_df = (rbind(plot_ind1,plot_ind2))
plot_df$mline = NA
plot_df[plot_df$Contract=="Permanent"&plot_df$Indicator=="Type 1",]$mline = ME_matrix4a[1,1] 
plot_df[plot_df$Contract=="Other"&plot_df$Indicator=="Type 1",]$mline = ME_matrix4a[2,2] 
plot_df[plot_df$Contract=="Flexible"&plot_df$Indicator=="Type 1",]$mline = ME_matrix4a[3,3] 
plot_df[plot_df$Contract=="Permanent"&plot_df$Indicator=="Type 2",]$mline = ME_matrix4b[1,1] 
plot_df[plot_df$Contract=="Other"&plot_df$Indicator=="Type 2",]$mline = ME_matrix4b[2,2] 
plot_df[plot_df$Contract=="Flexible"&plot_df$Indicator=="Type 2",]$mline = ME_matrix4b[3,3] 
```

```{r}
#Plot measurement error probability estimates
g = plot_df[plot_df$N==10000,] %>% ggplot( aes(x=indicator, y=MEP, fill=type)) + geom_bar(stat='identity', position='dodge')+ scale_fill_manual(name="Model",values=group.colors) 
g = g  + labs(y= "Measurement error probability estimates", x = "Number of indicators")
g = g + facet_grid(rows = vars(Contract),cols=vars(Indicator),labeller=label_both)  + geom_hline(aes(yintercept=mline), color = "black",size=0.3)
g = g +  geom_errorbar(aes(ymin=MEP-sd_MEP, ymax=MEP+sd_MEP), width=.25, size=0.3, position=position_dodge(.9))
filename = paste0("F:/Documents/Thesis/Schrijfbestanden/figures/test.pdf")
# ggsave(plot = g, width = 6, height = 5, dpi = 300, filename = filename)
```

```{r}
#Plot RMSE of measurement error probability estimates
plot_df = df_ME[df_ME$ME=="approx. 10% (realistic)",]
plot_df$ind = as.factor(plot_df$ind)
levels(plot_df$ind) = c("Type 1","Type 2")

h = plot_df %>% ggplot( aes(x=indicator, y=rmse, fill=type)) + geom_bar(stat='identity', position='dodge')+ scale_fill_manual(name="Model",values=group.colors) 
h = h  + labs(y= "RMSE", x = "Number of indicators")
h = h + facet_grid(rows = vars(Contract),cols=vars(ind),labeller=label_both) 
```

```{r}


```
